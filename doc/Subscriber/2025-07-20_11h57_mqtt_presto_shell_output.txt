Sunday 2025-07-20 11h57 utc+1
board: Adafruit Feather ESP32-S3 TFT
IDE: Arduino v2.3.5
Sketch: Feather_ESP32_S3_TFT_MQTT_multi_msg_type_without_debug.ino

Notes: 1) moved global variable "remote_led_is_on" from function send_msg()  to function handleButtonPress()
       2) in function handleButtonPress added print statements to show the (altered) state of the global variable
	      remote_led_is_on.
		  
Serial Monitor output:

‚ùå Couldn't find Adafruit LC709203F?
Checking for Adafruit MAX1704X..
‚úÖ Found MAX17048 with Chip ID: 0xC
Default port (Wire) I2C scan: 0x23, 0x36, 0x50, 0x51, 0x6A, 0x76, 
‚úÖ RTC found at address: 0x51. Starting it.
‚úÖ BME280 address: 0x76
‚úÖ BME280 successfully (re-)initiated.
‚úÖ gamepad QT address: 0x50
‚úÖ seesaw started
‚úÖ Found Product 5743
‚úÖ Connected to SSID: <Your_WiFi_SSID>
IP Address: 192.168._.___
Timezone offset = 1 hour(s)
Starting connection to NTP server...
‚úÖ MQTT You're connected to broker: 192.168._.___:1883
üïí ===>>> Update from NTP Server
‚úÖ NTP Unix time (UTC) = 1753009057
‚úÖ RTC successfully set from Unix time.
getUnixTimeFromRTC(): RTCdate and time: Sunday, 2025-07-20T10:57:37 UTC
getUnixTimeFromRTC(): HoursLocal = 11, HoursLocal_old = 255
-------------------------------------------------------

board ID = "Feather"
loop(): MQTT message send interval = 1 minute
Joystick x: 504, y: 505
üïí ===>>> ‚úÖ NTP Unix time (UTC) = 1753009057
‚úÖ RTC successfully set from Unix time.
getUnixTimeFromRTC(): RTCdate and time: Sunday, 2025-07-20T10:57:37 UTC
getUnixTimeFromRTC(): HoursLocal = 11, HoursLocal_old = 11
-------------------------------------------------------
getUnixTimeFromRTC(): RTCdate and time: Sunday, 2025-07-20T10:57:37 UTC
getUnixTimeFromRTC(): HoursLocal = 11, HoursLocal_old = 11
Bytes written by composePayload(): 253
Topic: "sensors/Feath/ambient"
contents payloadBuffer: 
{"ow":"Feath","de":"PC-Lab","dc":"BME280","sc":"meas","vt":"f","ts":1753012657,"reads":{"t":{"v":28.7,"u":"C","mn":-10,"mx":50},
"p":{"v":1002.3,"u":"mB","mn":800,"mx":1200},"a":{"v":91.4,"u":"m","mn":0,"mx":3000},"h":{"v":48.5,"u":"%","mn":0,"mx":100}}}
Topic length: 21
Payload length: 253
MQTT message ID: 1753012657 = 2025-07-20T11:57:37+01:00
MQTT message group:   1 sent
-------------------------------------------------------

‚úÖ gamepad QT address: 0x50

Button B pressed
remote light changed. Light = On

New Msg type:
lights_toggle

getUnixTimeFromRTC(): RTCdate and time: Sunday, 2025-07-20T10:58:37 UTC
getUnixTimeFromRTC(): HoursLocal = 11, HoursLocal_old = 11
Bytes written by composePayload(): 116
Topic: "lights/Feath/toggle"
contents payloadBuffer: 
{"ow":"Feath","de":"PC-Lab","dc":"home","sc":"ligh","vt":"i",
"ts":1753012717,"toggle":{"v":1,"u":"i","mn":1,"mx":0}}                 <<<=== see: "v":1
Topic length: 19
Payload length: 116
MQTT message ID: 1753012717 = 2025-07-20T11:58:37+01:00
MQTT message group:   2 sent
-------------------------------------------------------
‚úÖ gamepad QT address: 0x50

Button B pressed
remote light changed. Light = Off

New Msg type:
lights_toggle

getUnixTimeFromRTC(): RTCdate and time: Sunday, 2025-07-20T11:04:37 UTC
getUnixTimeFromRTC(): HoursLocal = 12, HoursLocal_old = 12
Bytes written by composePayload(): 116
Topic: "lights/Feath/toggle"
contents payloadBuffer: 
{"ow":"Feath","de":"PC-Lab","dc":"home","sc":"ligh","vt":"i",
"ts":1753013077,"toggle":{"v":0,"u":"i","mn":1,"mx":0}}                 <<<=== see: "v":0
Topic length: 19
Payload length: 116
MQTT message ID: 1753013077 = 2025-07-20T12:04:37+01:00
MQTT message group:   8 sent

-----------------------------------------------------------------------------------------
Result in the subscribed device (a Pimoroni Presto)
-----------------------------------------------------------------------------------------
>>> %Run -c $EDITOR_CONTENT

MPY: soft reboot
global(): error class object created. It is of class: <class 'ERR'>
Using local Broker
main(): Connecting to WiFi...
main(): WiFi connected.
setup(): Connecting to MQTT broker at 192.168.1.114 on port 1883
setup(): Not deleting log files, flag: "delete_logs" = False
setup(): Successfully connected to MQTT broker.
setup(): Subscribed to topic: "sensors/Feath/ambient"
setup(): Subscribed to topic: "lights/Feath/toggle"
setup(): Subscribed to topic: "lights/Feath/color_inc"
setup(): Subscribed to topic: "lights/Feath/color_dec"
draw(): hh = 0
Decoded string length: 116
raw msg: {"ow":"Feath","de":"PC-Lab","dc":"home","sc":"ligh","vt":"i","ts":1753013257,"toggle":{"v":0,"u":"i","mn":1,"mx":0}}
mqtt_callback(): Received a mqtt message on topic: "lights/Feath/toggle", timestamp: 1753013257
split_msg(): Topic rcvd: b'lights/Feath/toggle' found in TOPIC_LST: b'lights/Feath/toggle'
toggle payload.items() = dict_items([('u', 'i'), ('mx', 0), ('mn', 1), ('v', 0)])
key =  u, data =  i
key = mx, data =  0
key = mn, data =  1
key =  v, data =  0                             <<<=== v = 0
split_msg(): switching ambient LEDs off         <<<=== confirmation print to REPL.
draw(): hh = 0
draw(): time_draw = 12:07:37

Note: however the bl leds keep on flashing! I have to "repair" this faulty behaviour.


---------------------------------------------
Partial output after various changes into the micropython script:


raw msg: {"ow":"Feath","de":"PC-Lab","dc":"home","sc":"ligh","vt":"i","ts":1753023697,"toggle":{"v":0,"u":"i","mn":1,"mx":0}}
mqtt_callback(): Received a mqtt message on topic: "lights/Feath/toggle", timestamp: 1753023697

split_msg(): Topic rcvd: b'lights/Feath/toggle' found in TOPIC_LST: b'lights/Feath/toggle'
toggle payload.items() = dict_items([('u', 'i'), ('mx', 0), ('mn', 1), ('v', 0)])

get_payload_member(): key tm found in entry {'tm': '14:57:37'}
draw(): time_draw = 14:57:37

get_payload_member(): key tm found in entry {'tm': '14:57:37'}

get_payload_member(): key dc found in entry {'dc': 'home'}

get_payload_member(): key ts found in entry {'ts': '1753023457'}

get_payload_member(): key v not found in entry {'ow': 'Feath'}
get_payload_member(): key v not found in entry {'de': 'PC-Lab'}
get_payload_member(): key v not found in entry {'dc': 'home'}
get_payload_member(): key v not found in entry {'sc': 'lights'}
get_payload_member(): key v not found in entry {'vt': 'int'}
get_payload_member(): key v not found in entry {'tm': '14:57:37'}
get_payload_member(): key v not found in entry {'ts': '1753023457'}

-------------------
After some changes:
-------------------
>>> %Run -c $EDITOR_CONTENT

MPY: soft reboot
global(): error class object created. It is of class: <class 'ERR'>
Using local Broker
main(): Connecting to WiFi...
main(): WiFi connected.
setup(): Switching backlight neopixel leds off
setup(): Connecting to MQTT broker at 192.168.1.114 on port 1883
setup(): Not deleting log files, flag: "delete_logs" = False
setup(): Successfully connected to MQTT broker.
setup(): Subscribed to topic: "sensors/Feath/ambient"
setup(): Subscribed to topic: "lights/Feath/toggle"
setup(): Subscribed to topic: "lights/Feath/color_inc"
setup(): Subscribed to topic: "lights/Feath/color_dec"
draw(): hh = 0
Decoded string length: 116
raw msg: {"ow":"Feath","de":"PC-Lab","dc":"home","sc":"ligh","vt":"i","ts":1753024838,"toggle":{"v":0,"u":"i","mn":1,"mx":0}}
mqtt_callback(): Received a mqtt message on topic: "lights/Feath/toggle", timestamp: 1753024838
split_msg(): Topic rcvd: b'lights/Feath/toggle' found in TOPIC_LST: b'lights/Feath/toggle'
split_msg(): toggle payload.keys() = dict_keys(['u', 'mx', 'mn', 'v'])
split_msg(): toggle payload.items() = dict_items([('u', 'i'), ('mx', 0), ('mn', 1), ('v', 0)])
split_msg():  key =  u, data =  i
split_msg():  key = mx, data =  0
split_msg():  key = mn, data =  1
split_msg():  key =  v, data =  0
draw(): hh = 0
get_payload_member(): key tm found in entry {'tm': '15:20:38'}
draw(): time_draw = 15:20:38
get_payload_member(): key tm found in entry {'tm': '15:20:38'}
get_payload_member(): key de found in entry {'de': 'PC-Lab'}
get_payload_member(): key dc found in entry {'dc': 'home'}
get_payload_member(): key ts found in entry {'ts': '1753024838'}
draw(): toggle_draw = 
draw(): topic_idx = 1

----------------------
After various changes:
----------------------

>>> %Run -c $EDITOR_CONTENT

MPY: soft reboot
global(): error class object created. It is of class: <class 'ERR'>
Using local Broker
main(): Connecting to WiFi...
main(): WiFi connected.
setup(): Switching backlight neopixel leds off
NP_clear(): üåà ambient neopixels off
setup(): Connecting to MQTT broker at 192.168.1.114 on port 1883
setup(): Not deleting log files, flag: "delete_logs" = False
setup(): Successfully connected to MQTT broker.
setup(): Subscribed to topic: "sensors/Feath/ambient"
setup(): Subscribed to topic: "lights/Feath/toggle"
setup(): Subscribed to topic: "lights/Feath/color_inc"
setup(): Subscribed to topic: "lights/Feath/color_dec"
draw(): hh = 0
mqtt_callback(): Decoded raw_msg length: 116
mqtt_callback(): raw_msg: {"ow":"Feath","de":"PC-Lab","dc":"home","sc":"ligh","vt":"i","ts":1753041781,"toggle":{"v":1,"u":"i","mn":1,"mx":0}}
mqtt_callback(): Received a mqtt message on topic: "lights/Feath/toggle", timestamp: 1753041781
split_msg():  key =  u, data =  i
split_msg():  key = mx, data =  0
split_msg():  key = mn, data =  1
split_msg():  key =  v, data =  1
split_msg(): Toggling backlight neopixel leds on             <<<=== Note @PaulskPt: I saw the 7 leds switch on 
NP_color(): lightsColorIdx: 0 = color "BLUE"                        with default color (0) BLUE
NP_color(): üåà ambient neopixels color set to: r = 20, g = 0, b = 255
draw(): hh = 0
draw(): time_draw = 20:03:01
draw(): toggle_draw1 = lights_ON = Yes,
draw(): toggle_draw2 = lights_ON_old = No
draw(): topic_idx: 1 = topic: "lights/Feath/toggle"

mqtt_callback(): Decoded raw_msg length: 116
mqtt_callback(): raw_msg: {"ow":"Feath","de":"PC-Lab","dc":"home","sc":"ligh","vt":"i","ts":1753041901,"toggle":{"v":0,"u":"i","mn":1,"mx":0}}
mqtt_callback(): Received a mqtt message on topic: "lights/Feath/toggle", timestamp: 1753041901
split_msg():  key =  u, data =  i
split_msg():  key = mx, data =  0
split_msg():  key = mn, data =  1
split_msg():  key =  v, data =  0
split_msg(): Toggling backlight neopixel leds off             <<<=== Note @PaulskPt: I saw the 7 leds switch off
NP_clear(): üåà ambient neopixels off
draw(): hh = 0
draw(): time_draw = 20:05:01
draw(): toggle_draw1 = lights_ON = No,
draw(): toggle_draw2 = lights_ON_old = Yes
draw(): topic_idx: 1 = topic: "lights/Feath/toggle"
mqtt_callback(): Decoded raw_msg length: 116
mqtt_callback(): raw_msg: {"ow":"Feath","de":"PC-Lab","dc":"home","sc":"ligh","vt":"i","ts":1753041961,"toggle":{"v":0,"u":"i","mn":1,"mx":0}}
mqtt_callback(): Received a mqtt message on topic: "lights/Feath/toggle", timestamp: 1753041961
split_msg():  key =  u, data =  i
split_msg():  key = mx, data =  0
split_msg():  key = mn, data =  1
split_msg():  key =  v, data =  0
split_msg(): Not toggling backlight neopixel leds. lights_ON = False, lights_ON_old = False
draw(): hh = 0
draw(): time_draw = 20:06:01
draw(): toggle_draw1 = lights_ON = No,
draw(): toggle_draw2 = lights_ON_old = No
draw(): topic_idx: 1 = topic: "lights/Feath/toggle"
mqtt_callback(): Decoded raw_msg length: 116
mqtt_callback(): raw_msg: {"ow":"Feath","de":"PC-Lab","dc":"home","sc":"ligh","vt":"i","ts":1753042021,"toggle":{"v":0,"u":"i","mn":1,"mx":0}}

[...]

------------------------------------
Output of the mqtt publisher device:
------------------------------------

colorIndex = 6

New Msg type:
lights_color_inc

‚úÖ gamepad QT address: 0x50

Button X pressed
colorIndex = 7

New Msg type:
lights_color_inc

getUnixTimeFromRTC(): RTCdate and time: Sunday, 2025-07-20T19:10:02 UTC
getUnixTimeFromRTC(): HoursLocal = 20, HoursLocal_old = 20
Bytes written by composePayload(): 117
Topic: "lights/Feath/color_inc"
contents payloadBuffer: 
{"ow":"Feath","de":"PC-Lab","dc":"colr","sc":"inc","vt":"i",
"ts":1753042202,"colorInc":{"v":7,"u":"i","mn":0,"mx":9}}             <<<=== Color set to 7
Topic length: 22
Payload length: 117
MQTT message ID: 1753042202 = 2025-07-20T20:10:02+01:00
MQTT message group: 153 sent

-------------------------------------
Output of the mqtt subscriber device:
-------------------------------------

mqtt_callback(): Received a mqtt message on topic: "lights/Feath/color_inc", timestamp: 1753042202
NP_color(): lightsColorIdx: 7 = color "MAGENTA"
NP_color(): üåà ambient neopixels color set to: r = 255, g = 0, b = 255
draw(): hh = 0
draw(): time_draw = 20:10:02
draw(): color_txt1_draw = "lightsColorIdx = 7"                       <<<=== new color index: 7
draw(): color_txt2_draw = "MAGENTA"
draw(): topic_idx: 2 = topic: "lights/Feath/color_inc"

